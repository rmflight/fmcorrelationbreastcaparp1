<!--
% \VignetteEngine{knitr}
% \VignetteIndexEntry{fmanalysisbreastcaparp1: Expression}
% \VignetteDepends{GenomicRanges, fmdatabreastcaparp1}
% \VignettePackage{fmanalysisbreastcaparp1}
-->

# Correlation of transcript abundance and Parp1 at TSS

```{r setupKnitr, echo=FALSE, results='hide'}
knitr::opts_chunk$set(dev='CairoPNG')
```

```{r use_dir}
library(GenomicRanges)
library(magrittr)
options(mc.cores = 10)
library(parallel)
library(ggplot2)
library(rmfNotifier)
library(parp1)
library(BiocParallel)
library(GEOquery)
library(hgu133plus2.db)
library(fmanalysisbreastcaparp1)
```

In the initial analysis, we will use the Parp1 reads restricted to the TSS's. 

```{r load_data}
data(tss_windows)
data(parp1_ln4_unique)
data(parp1_ln5_unique)
data(expr_data)
```

Calculate the weighted coverage of the ln4 and ln5 sample reads, and then sum the reads in each TSS window.

```{r ln4_ln5_counts}
mcf7_cov <- coverage(parp1_ln4_unique, weight = "n_count")
mdamb231_cov <- coverage(parp1_ln5_unique, weight = "n_count")

tss_windows <- binned_function(tss_windows, mcf7_cov, "sum", "mcf7_read")
tss_windows <- binned_function(tss_windows, mdamb231_cov, "sum", "mdamb231_read")
```

Now, we need to translate the Affymetrix ID's to the Ensembl ID's that define the transcription start sites.

```{r translate_affy}
affy_2_ensembl <- select(hgu133plus2.db, keys = rownames(expr_data), columns = "ENSEMBLTRANS")
expr_data$ENSEMBL <- ""
expr_data <- expr_data[affy_2_ensembl[,1],]
expr_data$ENSEMBL <- affy_2_ensembl[,2]
```

Because we have many cases where there are multiple transcripts per Affy ID, and multiple Affy IDs for some transcripts, we need to go through each of the Ensembl transcripts and do averaging if necessary. 

